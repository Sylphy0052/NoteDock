# NoteDock システム仕様書

## 1. システム概要

### 1.1 システム名

本システムの正式名称は NoteDock とする。

### 1.2 目的

ITエンジニア少人数チーム向けの Markdownベース ナレッジ蓄積Webアプリ を提供する。

ノートに PDF / PPTX / 画像 / テキストファイルなどを紐付け、
ノート同士も #1 のような内部リンクでつなぎ、
「調査・設計・議論の情報」を一箇所に集約する。

コンテナ化し、オンプレミス or 自前サーバ1台上で動作させる。

### 1.3 想定利用環境

- 利用ユーザー：ITエンジニア数人のチーム
- 利用端末：PC（デスクトップ）前提、横幅 1280px 以上
- ネットワーク：閉じた社内ネットワーク上（VPN など）

### 1.4 認証・ワークスペース

- 認証なし（ログイン画面なし）
- 1インスタンス = 1チーム専用（マルチワークスペースなし）

## 2. 機能要件

### 2.1 ノート管理

#### 2.1.1 ノート基本

**属性**

- id：連番の整数（1, 2, 3, …）
- タイトル
- 本文（Markdown）
- フォルダ（階層最大3段）
- タグ（複数、フリーワード）
- カバー画像（任意）
- ピン留めフラグ
- 閲覧専用フラグ（is_readonly）
- 作成日時／更新日時（JST、表示形式 YYYY/MM/DD HH:mm）

**操作**

- 作成／閲覧／編集／削除（ゴミ箱へ移動）
- 複製（タイトル・本文・タグ・フォルダ・カバー・添付をコピー）
- 閲覧専用ON/OFF切替
- ピン留めON/OFF切替

#### 2.1.2 ゴミ箱

削除 = ソフトデリート（deleted_at に日時を入れる）。

ゴミ箱画面から：

- 復元
- 完全削除

自動完全削除：

- deleted_at から 30日経過 したノートを自動で完全削除（毎日バッチ）。
- 関連バージョン履歴・コメント・リンク・添付紐付けも削除。
- 添付ファイル本体は、他ノートから参照されていない場合のみ MinIO から削除。

#### 2.1.3 編集ロック（簡易）

誰かが編集画面を開いた時、そのノートに「編集中フラグ」を立てる。

他のユーザー（ブラウザ）が同じノートの編集画面を開いた場合：

- 「現在他のユーザーが編集中です」と警告表示。
- 「閲覧のみ」か「ロックを無視して編集を続行」を選択できる仕様（実装時に詳細決定）。

#### 2.1.4 閲覧専用フラグ

ノート単位で is_readonly を持つ。

is_readonly = true の場合：

- 編集画面への遷移を禁止、または閲覧モードのみ。
- 閲覧専用のバッジ表示。

ロック／解除は誰でも可能だが、「本当に変更しますか？」の確認ダイアログを表示。

### 2.2 ノート間リンク機能

#### 2.2.1 リンク記法

- ノートには一意の整数IDが付与される（例：1）。
- Markdown本文内で #<数字> と書くと内部リンク候補とみなす。
- 例：#1 → ノートID = 1 へのリンク。
- レンダリング時に #(\d+) を解析し、IDが存在する場合のみリンク化。

#### 2.2.2 リンク表示

- 表示テキストは #1 のまま、もしくは #1: タイトル などに変換（実装時に決定）。
- クリック：該当ノートの詳細画面へ遷移。

#### 2.2.3 ホバー表示（プレビュー）

# 1 リンクにマウスオーバーすると、以下を表示するポップアップを出す

- ノートタイトル
- 本文先頭数百文字をプレーンテキスト化した概要
- 最終更新日時

実装方式：

- /api/notes/{id}/summary などでホバー時に取得
- または最初にまとめて取得してキャッシュ。

#### 2.2.4 無効リンク

存在しないIDの場合：

- リンク化しないか、クリック時にエラー表示（実装ポリシーで選択）。

### 2.3 ノートリンク・グラフビュー（リンクマップ）

#### 2.3.1 全体マップ

すべてのノートとノート間リンクをグラフ表示：

- ノート = ノード（タイトルを付与）
- #ID による参照 = 矢印付きエッジ

動作：

- ノードクリック → 該当ノート詳細へ遷移
- ホバー → タイトル＋概要表示
- ズームイン／アウト／全体表示リセット

#### 2.3.2 近傍グラフ

特定ノートを中心に：

- そのノートがリンクしているノート
- そのノートを参照しているノート
- （必要に応じて2ホップ先まで）

ノート詳細画面から「リンクマップで見る」操作で表示。

#### 2.3.3 内部データ

（任意）note_links テーブルで from/to を持ち、解析結果を保存して再利用しても良い。

### 2.4 添付ファイル管理

#### 2.4.1 対応ファイル種別

- PDF（.pdf）
- PowerPoint（.ppt, .pptx）
- 画像（.png, .jpg, .jpeg, .gif, .webp 等）
- テキスト（.txt, .md）

#### 2.4.2 アップロード

- ノート編集画面でドラッグ＆ドロップまたはファイル選択でアップロード。
- 1ノートあたりの添付数上限：50件
- ファイルサイズ上限：アプリ側では制限なし（インフラの制約に依存）。
- 合計ストレージ容量制限：なし（インフラ運用で管理）。

#### 2.4.3 保存先

S3互換ストレージ（MinIO）に保存。

- バケット例：notedock-files
- オブジェクトキー例：
  - attachments/<note_id>/<uuid>.<ext>
  - covers/<note_id>/<uuid>.<ext>

#### 2.4.4 一覧表示

ノート詳細画面に「添付ファイル一覧」：

- アイコン＋ファイル名（＋サイズ任意）
- 画像のみサムネイル表示（縮小）

#### 2.4.5 Viewer

- 画像：モーダルで拡大表示（ライトボックス風）。
- PDF：PDF Viewer（pdf.js など）でモーダル or 新規タブ表示。
- テキスト：モーダルでテキスト表示（.md はそのままテキスト扱い or Markdownレンダリング）。
- PPT/PPTX：ダウンロードのみ（v1ではプレビューなし）。

#### 2.4.6 Markdown内で画像貼り付け

画像をアップロード後、Viewer用URLが発行される。

「画像挿入」ボタンから：

- アップロード or 既存画像選択
- Markdownに ![](画像URL) を自動挿入。

手打ちでも同じURLで埋め込み可能。

### 2.5 Markdown仕様

#### 2.5.1 基本

対応構文：

- 見出し（#〜######）
- 強調（*italic*, **bold**）
- 箇条書き・番号付きリスト
- 引用
- コードブロック（```）
  - 言語指定あり（```ts,```python など）
  - シンタックスハイライトあり
- 表
- チェックボックス（- [ ]）
- リンク・画像
- ノート間リンク：#<数字>（別処理）

#### 2.5.2 Mermaid対応

- ```mermaid ...``` のブロックを認識し、Mermaid.jsなどで図を描画。
- シーケンス図、フローチャートなどをサポート。

#### 2.5.3 禁止事項

生HTMLは禁止：

- <div>, <span>, <script>, <iframe> などすべてのHTMLタグを無効化 or エスケープ。
- XSS 対策のため。

#### 2.5.4 エディタ

レイアウト：

- 左：プレーンなMarkdownテキストエリア
- 右：ライブプレビュー
- 「エディタのみ／プレビューのみ／両方」切り替え可能。

ツールバー（軽いWYSIWYG要素）：

- 太字／斜体／見出し／リスト／コードブロック／リンク／チェックボックスなど挿入ボタン。

ショートカット（VSCode風）：

- Ctrl+S：保存
- Ctrl+B：太字
- Ctrl+I：斜体
- Ctrl+Shift+H：見出し2
- Ctrl+Shift+L：リスト
- Ctrl+Shift+C：コードブロック
- （他も適宜）

### 2.6 TOC（目次）機能

- 対象：h2見出し（##）のみ。
- ノート本文から h2 を抽出し、TOCを生成：
  - id（セクションID）、text（見出し文）を持つリスト。
- ノート詳細画面では右サイドにTOCサイドバーを表示：
  - 見出しリストをクリック → 対応する見出し位置へスムーススクロール。
- h2要素には一意な id を付与。

### 2.7 コメント機能

ノートごとに スレッド形式コメント を持つ。

コメント属性：

- 本文
- 親コメントID（スレッド用）
- 表示名
- 作成日時／更新日時

表示名：

- ユーザーは最初にアプリ上部の設定で「表示名」を登録。
- 表示名はブラウザのローカルストレージに保存。

編集／削除：

- 「この端末で設定した表示名」と同じ表示名のコメントのみ、編集・削除ボタンを表示。
- 実装上はフロント側で制御（認証なし前提の緩い制約）。

コメントは検索対象 外。

### 2.8 テンプレート

- 任意のノートを「テンプレートとして保存」可能。
- 新規ノート作成時：
  - システム標準テンプレート（議事録・設計・調査など）
  - ユーザー作成テンプレート
  - から選択可能。
- テンプレート保存時：
  - タイトル／本文／タグ／フォルダなどをテンプレートとして記録。

### 2.9 バージョン履歴

#### 2.9.1 生成タイミング

- 「保存」ボタン押下時に 正式バージョン を作成。
- 別途ドラフト自動保存（例：一定秒ごと）を行うが、ドラフトは履歴としては保持しない。

#### 2.9.2 閲覧・復元

ノート詳細画面からバージョン一覧表示：

- バージョン番号／作成日時／概要など。
- 任意のバージョンを閲覧可能。

「このバージョンに戻す」操作：

- 選択バージョンの内容を現在版にコピーし、新たなバージョンとして追加。

#### 2.9.3 上限・クリーンアップ

- 各ノートごとの履歴は 最大50件。
- 1年以上前のバージョンは自動削除対象。
- 毎日バッチで：
  - created_at が1年以上前のもののうち、最新50件に含まれないものを削除。

### 2.10 検索・ナビゲーション

#### 2.10.1 通常検索

検索対象：

- ノートタイトル
- 本文（Markdownテキスト）
- タグ

手法：シンプルな部分一致検索（LIKE等）。

ソート：更新日時降順。

#### 2.10.2 クイックオープン

- ショートカット：Ctrl+K
- ポップアップでタイトル・タグを対象にインクリメンタルサーチ。
- Enterで選択ノート詳細へ遷移。

### 2.11 フォルダ・タグ

フォルダ：

- 階層最大3段まで。
- UI上でツリー表示。

タグ：

- フリーワード形式。
- 入力時に既存タグをサジェスト表示。
- 大文字・小文字区別は実装時に決定（基本はそのまま）。

### 2.12 ダッシュボード・ナビゲーション

ホーム（ダッシュボード）：

- 上部：ピン留めノート
- 中央：最近開いたノート
- 下部：最近更新されたノート

ノート一覧：

- カバー画像つきカード表示。
- ページネーション（1ページ20件など）。

ナビ構成：

- 上ヘッダー：ロゴ、検索バー、クイックオープン、テーマ切替、表示名設定、（設定リンク）
- 左サイドバー：ホーム、ノート、タグ、ゴミ箱、リンクマップ

### 2.13 Discord連携

- 設定：Discord Webhook URL は環境変数等で指定（UIから変更不可）。
- 通知イベント：
  - 新規ノート作成
  - ノート更新
  - コメント投稿
- 通知内容（例）：
  - メッセージタイトル＋ノートタイトル＋URL＋日時など。
- Discordエラー時はログ記録のみでアプリ処理は継続。

### 2.14 インポート／エクスポート

エクスポート：

- ノートを .md として出力。
- 添付ファイルも含め、フォルダ構成 or ZIP でダウンロード。

インポート：

- ZIPなどから .md と添付ファイルを読み込み、新規ノートとして作成。
- フォルダ構成をマッピング（簡易でよい）。

### 2.15 AI機能

#### 2.15.1 概要

ASK API と連携し、ノートに対するAI支援機能を提供する。

- ノートの要約生成
- ノート内容に関する質問応答
- 文章の改善・編集支援

#### 2.15.2 対応モデル

複数のAIモデルから選択可能（設定画面で変更）：

**OpenAI:**

- GPT-4o, GPT-4o mini, GPT-4.1
- GPT-5, GPT-5.1, GPT-5.2（Thinking版含む）
- o3-mini, o3-mini-high, o4-mini, o4-mini-high

**Anthropic:**

- Claude 4 Sonnet, Claude 4 Sonnet Thinking
- Claude Sonnet 4.5, Claude Sonnet 4.5 Thinking

**Google:**

- Gemini 2.0 Flash, Gemini 2.0 Flash Web Search
- Gemini 2.5 Flash, Gemini 2.5 Flash Lite, Gemini 2.5 Flash Web Search

#### 2.15.3 モデル速度カテゴリ

UIでユーザーがモデル選択しやすいよう、応答速度で3段階に分類：

| カテゴリ | 閾値 | 用途 |
|----------|------|------|
| 高速（Fast） | < 2秒 | 日常的な使用 |
| 標準（Medium） | < 5秒 | バランス重視 |
| 低速（Slow） | >= 5秒 | 高度な推論 |

#### 2.15.4 機能一覧

**要約（Summarize）:**

- 対象ノートの本文を要約
- 要約の長さ（短/中/長）、スタイル（箇条書き/段落）を指定可能
- 追加ファイルをコンテキストとして添付可能

**質問応答（Ask）:**

- ノート内容に関する質問に回答
- 会話履歴を保持してフォローアップ質問が可能
- ファイルを追加コンテキストとして添付可能

**編集支援（Assist）:**

- 改善（improve）：文章を洗練
- 簡略化（simplify）：平易な表現に変換
- 拡張（expand）：内容を詳細化
- 翻訳（translate）：指定言語に翻訳
- カスタム：自由な指示

#### 2.15.5 設定

- 使用モデルは設定画面から変更可能
- デフォルトモデル：gemini-2.5-flash
- 環境変数でASK APIの接続情報を設定

## 3. 非機能要件

### 3.1 UI・テーマ

- UI言語：日本語のみ。
- テーマ：
  - ライト／ダーク両対応。
  - 初期値はOS設定（prefers-color-scheme）に追従。
  - 右上のテーマ切替ボタンでユーザーが変更可能。
  - 選択はローカルストレージに保存。

### 3.2 対応デバイス

- PC（デスクトップ）前提。
- モバイル・小さいタブレットはv1では未対応（多少崩れても許容）。

### 3.3 エラー表示

フォームバリデーション：

- 該当フィールド下に赤文字メッセージ。
- 入力欄の枠を赤に。

通知：

- 成功／情報 → 右上トースト。
- 致命的エラー → トースト＋画面上部アラートバー。

### 3.4 パフォーマンス

- ノート表示：サーバ処理1秒以内目標。
- 検索：2秒以内目標（件数増加時は要チューニング）。
- 同時利用：数人〜10人程度を想定。

### 3.5 セキュリティ

利用前提：閉じた社内ネットワーク。

最低限実施：

- HTTPS（インフラ側）
- XSS対策（Markdownサニタイズ、HTML禁止）
- CSRF対策（API設計）
- SQL Injection 対策（ORM使用）

認証なしのため、ネットワークレベルのアクセス制御必須。

### 3.6 バックアップ

cron等で自動バックアップ（サーバ上）：

- 毎日深夜に pg_dump でDBバックアップ。
- MinIOのデータディレクトリを tar.gz で取得。
- 保持期間はデフォルト30日程度（環境変数等で調整可能）。

### 3.7 ログ・監査

アプリログ：

- エラー／警告／主要イベントをログ出力。

操作ログ（DB）：

- ノート作成／更新／削除／復元
- バージョン復元
- 添付追加／削除
- コメント投稿／編集／削除

v1ではUIから操作ログは閲覧しない（内部調査用）。

## 4. システム構成

### 4.1 コンテナ構成（Docker）

**frontend：**

- Vite + React + TypeScript
- 本番ではビルドした静的ファイルを Nginx等で配信。

**backend：**

- FastAPI + Uvicorn
- SQLAlchemy + Alembic でDBアクセス・マイグレーション。

**db：**

- PostgreSQL

**storage：**

- MinIO（S3互換ストレージ）

※デプロイはオンプレ or 自前サーバ1台上で Docker Compose を使用。
ステージング環境は用意せず、本番のみ。

## 5. データモデル（概要）

### 5.1 notes

| カラム | 型 |
|--------|-----|
| id | INT, PK, auto increment |
| title | string |
| content_md | text |
| folder_id | FK → folders.id, nullable |
| is_pinned | bool |
| is_readonly | bool |
| cover_file_id | FK → files.id, nullable |
| created_at | datetime JST |
| updated_at | datetime JST |
| deleted_at | datetime, nullable |

### 5.2 note_versions

| カラム | 型 |
|--------|-----|
| id | PK |
| note_id | FK → notes.id |
| version_no | int |
| title | string |
| content_md | text |
| cover_file_id | nullable |
| created_at | datetime |

### 5.3 tags / note_tags

**tags：**

| カラム | 型 |
|--------|-----|
| id | PK |
| name | string |

**note_tags：**

| カラム | 型 |
|--------|-----|
| note_id | FK |
| tag_id | FK |

### 5.4 folders

| カラム | 型 |
|--------|-----|
| id | PK |
| name | string |
| parent_id | FK → folders.id, nullable |

※ 階層最大3段はアプリ側制御。

### 5.5 files

| カラム | 型 |
|--------|-----|
| id | PK |
| original_name | string |
| stored_key | MinIOのオブジェクトキー |
| mime_type | string |
| size_bytes | int |
| created_at | datetime |

### 5.6 note_files

| カラム | 型 |
|--------|-----|
| note_id | FK |
| file_id | FK |

### 5.7 comments

| カラム | 型 |
|--------|-----|
| id | PK |
| note_id | FK |
| parent_id | nullable |
| display_name | string |
| content | text |
| created_at | datetime |
| updated_at | datetime |

### 5.8 activity_logs（操作ログ）

| カラム | 型 |
|--------|-----|
| id | PK |
| event_type | "note_created" 等 |
| note_id / file_id / comment_id 等 | nullable |
| display_name | あれば |
| ip_address / user_agent | 必要に応じて |
| created_at | datetime |

## 6. API概要（ざっくり）

### ノート

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| GET | /api/notes | ノート一覧取得 |
| GET | /api/notes/{id} | ノート詳細取得 |
| POST | /api/notes | ノート作成 |
| PUT | /api/notes/{id} | ノート更新 |
| DELETE | /api/notes/{id} | ゴミ箱へ移動 |
| POST | /api/notes/{id}/restore | 復元 |
| POST | /api/notes/{id}/duplicate | 複製 |
| GET | /api/notes/{id}/versions | バージョン一覧 |
| POST | /api/notes/{id}/versions/{version_no}/restore | バージョン復元 |
| GET | /api/notes/{id}/summary | サマリー取得 |
| GET | /api/notes/{id}/toc | 目次取得 |

### ファイル

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| POST | /api/files | アップロード（multipart） |
| GET | /api/files/{id} | ダウンロード or ストリーム |
| GET | /api/files/{id}/preview | 画像/PDF表示用 |

### コメント

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| GET | /api/notes/{id}/comments | コメント一覧 |
| POST | /api/notes/{id}/comments | コメント投稿 |
| PUT | /api/comments/{id} | コメント編集 |
| DELETE | /api/comments/{id} | コメント削除 |

### 検索

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| GET | /api/search | 検索（q, tag, folder 等） |

### リンクマップ

| メソッド | エンドポイント | 説明 |
|----------|----------------|------|
| GET | /api/linkmap | 全体マップ |
| GET | /api/linkmap/{note_id} | 近傍マップ |
